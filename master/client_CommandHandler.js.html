<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>client/CommandHandler.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Client.html#getConfigOption">getConfigOption</a></li><li data-type='method'><a href="Client.html#loadHelp">loadHelp</a></li><li data-type='method'><a href="Client.html#setConfigOption">setConfigOption</a></li></ul></li><li><a href="Command.html">Command</a><ul class='methods'><li data-type='method'><a href="Command.html#registerSubCommand">registerSubCommand</a></li><li data-type='method'><a href="Command.html#setAlias">setAlias</a></li><li data-type='method'><a href="Command.html#setSubAlias">setSubAlias</a></li></ul></li><li><a href="CommandHandler.html">CommandHandler</a><ul class='methods'><li data-type='method'><a href="CommandHandler.html#getCommand">getCommand</a></li></ul></li><li><a href="ForgeRegistry.html">ForgeRegistry</a><ul class='methods'><li data-type='method'><a href="ForgeRegistry.html#registerAlias">registerAlias</a></li><li data-type='method'><a href="ForgeRegistry.html#registerCommand">registerCommand</a></li><li data-type='method'><a href="ForgeRegistry.html#registerPlugin">registerPlugin</a></li><li data-type='method'><a href="ForgeRegistry.html#removeCommand">removeCommand</a></li><li data-type='method'><a href="ForgeRegistry.html#removePlugin">removePlugin</a></li></ul></li><li><a href="Plugin.html">Plugin</a><ul class='methods'><li data-type='method'><a href="Plugin.html#registerCommand">registerCommand</a></li><li data-type='method'><a href="Plugin.html#removeCommand">removeCommand</a></li></ul></li></ul><h3>Externals</h3><ul><li><a href="external-Client.html">Client</a></li><li><a href="external-ClientOptions.html">ClientOptions</a></li><li><a href="external-Collection.html">Collection</a></li><li><a href="external-EvaluatedPermissions.html">EvaluatedPermissions</a></li><li><a href="external-Guild.html">Guild</a></li><li><a href="external-GuildMember.html">GuildMember</a></li><li><a href="external-Message.html">Message</a></li><li><a href="external-Role.html">Role</a></li></ul><h3>Events</h3><ul><li><a href="Client.html#event:command">command</a></li><li><a href="Client.html#event:plainMessage">plainMessage</a></li><li><a href="Plugin.html#event:load">load</a></li></ul><h3>Interfaces</h3><ul><li><a href="GuildExtention.html">GuildExtention</a><ul class='methods'><li data-type='method'><a href="GuildExtention.html#changePrefix">changePrefix</a></li><li data-type='method'><a href="GuildExtention.html#disablePlugin">disablePlugin</a></li><li data-type='method'><a href="GuildExtention.html#enablePlugin">enablePlugin</a></li><li data-type='method'><a href="GuildExtention.html#registerCommand">registerCommand</a></li><li data-type='method'><a href="GuildExtention.html#removeCommand">removeCommand</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#hasRole">hasRole</a></li><li><a href="global.html#openJSON">openJSON</a></li><li><a href="global.html#openJSONSync">openJSONSync</a></li><li><a href="global.html#timeToMs">timeToMs</a></li><li><a href="global.html#writeJSON">writeJSON</a></li><li><a href="global.html#writeJSONSync">writeJSONSync</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">client/CommandHandler.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *  This is the chat handling class file. This is the command running code. Very finiky
 *
 */
class CommandHandler {
  constructor(client) {
    this.client = client;
  }

  handleMessage(message, author, channel, guild) {
    if (author.bot) return this.client.emit('plainMessage', message);
    if (this.client.options.selfBot === true &amp;&amp; author.id !== this.client.user.id) return this.client.emit('plainMessage', message);
    if (this.client.options.guildConfigs === true &amp;&amp; channel.type === 'text') return this.perGuild(message, author, channel, guild);
    if (channel.type === 'group') return this.handleGroupDM(message, author, channel);
    if (channel.type === 'dm') return this.handleDM(message, author, channel);
    let cmdArgs = message.content.split(' ');
    if (channel.type === 'text') {
      if (cmdArgs[0].substring(0, this.client.options.prefix.length) !== this.client.options.prefix) return this.client.emit('plainMessage', message);

      const command = this.getCommand(message);
      if (command !== undefined) {
        if (command.dmOnly === true) return this.client.emit('plainMessage', message);
        if (typeof command.message === 'string') {
          channel.sendMessage(command.message);
        } else if (typeof command.message === 'function') {
          command.message(message, author, channel, guild, this.client);
        } else if (command.responses.length > 1) {
          let response = command.responses[Math.random() * (command.responses.length - 1)];
          if (typeof response === 'string') {
            channel.sendMessage(response);
          } else if (typeof response === 'function') {
            response(message, author, channel, guild, this.client);
          }
        }
        return this.client.emit('command', command);
      }
    }
    return this.client.emit('plainMessage', message);
  }

  handleGroupDM(message, author, group) {
    let cmdArgs = message.content.split(' ');
    if (cmdArgs[0].substring(0, this.client.options.prefix.length) !== this.client.options.prefix) this.client.emit('plainMessage', message);
    const command = this.getCommand(message);
    if (command) {
      if (command.guildOnly === true) return this.client.emit('plainMessage', message);
      if (typeof command.message === 'string') {
        group.sendMessage(command.message);
      } else if (typeof command.message === 'function') {
        command.message(message, author, group, this.client);
      } else if (command.responses.length > 1) {
        let response = command.responses[Math.random() * (command.responses.length - 1)];
        if (typeof response === 'string') {
          group.sendMessage(response);
        } else if (typeof response === 'function') {
          response(message, author, group, this.client);
        }
      }
      return this.client.emit('command', command);
    }
    return this.client.emit('plainMessage', message);
  }

  handleDM(message, author, dmChannel) {
    let cmdArgs = message.content.split(' ');
    if (cmdArgs[0].substring(0, this.client.options.prefix.length) !== this.client.options.prefix) return false;
    const command = this.getCommand(message);
    if (command) {
      if (command.guildOnly === true) return false;
      // if (this.testPermissions(command, author))
      if (typeof command.message === 'string') {
        dmChannel.sendMessage(command.message);
      } else if (typeof command.message === 'function') {
        command.message(message, author, dmChannel, this.client);
      } else if (command.responses.length > 1) {
        let response = command.responses[Math.random() * (command.responses.length - 1)];
        if (typeof response === 'string') {
          dmChannel.sendMessage(response);
        } else if (typeof response === 'function') {
          response(message, author, dmChannel, this.client);
        }
      }
      return this.client.emit('command', command);
    }
    return this.client.emit('plainMessage', message);
  }

  perGuild(message, author, channel, guild) {
    let cmdArgs = message.content.split(' ');
    if (cmdArgs[0].substring(0, guild.prefix.length) !== guild.prefix) return this.client.emit('plainMessage', message);
    const command = this.getCommand(message, true);
    if (command) {
      if (command.dmOnly === true) return this.client.emit('plainMessage', message);
      if (typeof command.message === 'string') {
        channel.sendMessage(command.message);
      } else if (typeof command.message === 'function') {
        command.message(message, author, channel, guild, this.client);
      }
      /* else if (command.responses.length > 1) {
             let response = command.responses[Math.random() * (command.responses.length - 1)];
             if (typeof response === 'string') {
               return channel.sendMessage(response);
             } else if (typeof response === 'function') {
               return response(message, author, channel, guild, this.client);
             }
           }*/
      return this.client.emit('command', command);
    }
    return this.client.emit('plainMessage', message);
  }

  /**
   * Checks if a message is a command
   * @param {Message} message The message to get the command from
   * @param {boolean} guildConfigs Whether or not custom configs is enabled
   * @returns {?Command}
   */
  getCommand(message, guildConfigs = false) {
    let command = null;
    let args = message.content.split(' ');
    let label = guildConfigs ? args[0].substring(message.guild.prefix.length) : args[0].substring(this.client.options.prefix.length);
    if (guildConfigs) {
      message.guild.commands.forEach(cmd => { command = this.testComparator(cmd, label) ? cmd : label === cmd.id ? cmd : command; });
      this.client.registry.commands.forEach(cmd => { command = this.testComparator(cmd, label) ? cmd : label === cmd.id ? cmd : command; });
      this.client.registry.plugins.forEach(plugin => {
        if (message.guild.enabledPlugins.indexOf(plugin.id) !== -1) plugin.commands.forEach(cmd => { command = this.testComparator(cmd, label) ? cmd : label === cmd.id ? cmd : command; });
      });
    } else {
      this.client.registry.commands.forEach(cmd => { command = this.testComparator(cmd, label) ? cmd : label === cmd.id ? cmd : command; });
      this.client.registry.plugins.forEach(plugin => {
        plugin.commands.forEach(cmd => { command = this.testComparator(cmd, label) ? cmd : label === cmd.id ? cmd : command; });
      });
    }
    args.splice(0, 1);
    if (args.length > 0 &amp;&amp; command !== null) return this.getSubCommand(args, command);
    return command;
  }

  getSubCommand(args, command) {
    let id = command.subCommandAliases.get(args[0]) || args[0];
    let subCommand;
    if (((subCommand = command.subCommands.get(id)) !== undefined) || ((subCommand = command.subCommands.get(id.toLowerCase())) !== undefined &amp;&amp; subCommand.caseSensitive === false)) {
      args.splice(0, 1);
      if (args.length >= 1 &amp;&amp; subCommand !== undefined) return this.getSubCommand(args, subCommand);
      return subCommand;
    }
    return command;
  }

  testComparator(cmd, label) {
    let command;
    if (typeof cmd.comparator === 'string') {
      if (label === cmd.comparator) command = cmd;
    } else if (cmd.comparator instanceof RegExp) {
      if (cmd.comparator.test(label)) command = cmd;
    } else if (cmd.comparator instanceof Array) {
      cmd.comparator.forEach(comp => {
        if (typeof comp === 'string') {
          if (label === comp) command = cmd;
        } else if (comp instanceof RegExp) {
          if (comp.test(label)) command = cmd;
        }
      });
    }
    return !!command;
  }

  // testPermissions(cmd/*, member*/) {
    // return true;
  // }
}


module.exports = CommandHandler;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Jan 11 2017 16:36:36 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
